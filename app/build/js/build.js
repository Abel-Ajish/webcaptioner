function clear_saved(){ga("send","event","user","clearButtonClick"),confirm("Clear saved transcript?")&&($("#final_span").text(""),final_transcript="",window.localStorage.setItem("transcript",final_transcript))}function upgrade(){showInfo("info_upgrade")}function linebreak(n){return n.replace(two_line,"<p></p>").replace(one_line,"<br>")}function capitalize(n){return n.replace(first_char,function(n){return n.toUpperCase()})}function startButton(n){if(recognizing)return ga("send","event","user","stopButtonClick"),recognition.stop(),void $("#startButton").text("Start");ga("send","event","user","startButtonClick"),$("#startButton").text("Stop"),recognition.lang="en-US",recognition.start(),ignore_onend=!1,interim_span.innerHTML="",showInfo("info_allow"),start_timestamp=n.timeStamp}function showInfo(n){if(n){for(var t=info.firstChild;t;t=t.nextSibling)t.style&&(t.style.display=t.id==n?"inline":"none");info.style.visibility="visible"}else info.style.visibility="hidden"}showInfo("info_start"),document.getElementById("final_span").innerHTML=window.localStorage.getItem("transcript"),window.scrollTo(0,document.body.scrollHeight);var create_email=!1,final_transcript=window.localStorage.getItem("transcript")||"",recognizing=!1,ignore_onend,start_timestamp,restartingDueToFailure=!1;if("webkitSpeechRecognition"in window){var recognition=new webkitSpeechRecognition;recognition.continuous=!0,recognition.interimResults=!0,recognition.onstart=function(){recognizing=!0,showInfo("info_speak_now"),window.scrollTo(0,document.body.scrollHeight)},recognition.onerror=function(n){"no-speech"==n.error&&(showInfo("info_no_speech"),ignore_onend=!0),"audio-capture"==n.error&&(showInfo("info_no_microphone"),ignore_onend=!0),"not-allowed"==n.error&&(showInfo(n.timeStamp-start_timestamp<100?"info_blocked":"info_denied"),ignore_onend=!0)},recognition.onend=function(){if(restartingDueToFailure)return console.log("Restarting due to failure"),ga("send","event","recognition","restartingDueToPossibleFailure"),recognition.start(),void(restartingDueToFailure=!1);recognizing=!1,ignore_onend||showInfo(final_transcript?"":"info_start")};var lastResultTime=(new Date).getTime()/1e3;recognition.onresult=function(n){lastResultTime=(new Date).getTime()/1e3;var t="";if(void 0===n.results)return recognition.onend=null,recognition.stop(),void upgrade();for(var e=n.resultIndex;e<n.results.length;++e)n.results[e].isFinal?final_transcript+=n.results[e][0].transcript:t+=n.results[e][0].transcript;final_transcript=capitalize(final_transcript),final_span.innerHTML=linebreak(final_transcript),interim_span.innerHTML=linebreak(t),window.localStorage.setItem("transcript",final_transcript),window.scrollTo(0,document.body.scrollHeight)}}else upgrade();setInterval(function(){var n=(new Date).getTime()/1e3;recognizing&&n-lastResultTime>3&&(restartingDueToFailure=!0,recognition.stop())},3e3);var two_line=/\n\n/g,one_line=/\n/g,first_char=/\S/;$(function(){$("#final_span").on("keyup",function(n){final_transcript=$("#final_span").text(),window.localStorage.setItem("transcript",final_transcript)})});